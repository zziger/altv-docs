<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Async Module </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Async Module ">
    <meta name="generator" content="docfx 2.56.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css" integrity="sha512-xYwrX34LRktCfb+3WW0FtJf6qEc2tcJet152No8epFPBoM4qNaaVk5xdfCYI0Ns0H2jD0Isc3VoShSMv6zzpPA==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/solid.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../../styles/colors.css">
    <link rel="stylesheet" href="../../styles/discord.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>

  <body>

        <div class="body-content">

            <nav id="sidebar" role="navigation">

                <div class="sidebar">
                    
                    
                    
                    
                    <div>
                      
                      <a class="brand" href="../../index.html">
                        <img src="../../logo.svg" alt="alt:V" class="logomark">
                        <span class="brand-title">alt:V</span>
                      </a>
                      <div id="navbar">
                    
                      </div>
                    
                    </div>
                    

                    <div class="sidebar-item-separator"></div>

                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>

                </div>


            </nav>

            <main class="main-panel">

                <div class="blackout desktop-hide"></div>

                    
                    <div class="subnav navbar navbar-default">
                      <button class="btn-link search-back desktop-hide"></button>
                      <button class="btn-link navbar-toggler" aria-label="Toggle navigation"></button>
                      <div class="container" id="breadcrumb">
                        <ul class="breadcrumb">
                          <li></li>
                        </ul>
                      </div>
                      <div class="flex-space"></div>
                      <div class="toolbar">
                          <div style="position: relative;">
                            <form class="search-bar mobile-hide" role="search" id="search" style="position: relative;">
                              <button class="btn-link clear" id="search-query-clear"></button>
                              <!-- <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off"> -->
                              <div role="textbox" class="form-control" id="search-query" placeholder="Search" contenteditable="true"></div>
                            </form>
                            <div class="popout" id="search-menu">
                              <span class="title">
                                Search options:
                              </span>
                            </div>
                            <button class="btn-link search-tip desktop-hide"></button>
                          </div>
                      </div>
                      <button class="btn-link btn-floating search desktop-hide"></button>
                    </div>

                <div class="content-region" role="main">

                    <div class="content-column Conceptual">

                            
                            <div class="sideaffix hide-when-search">
                              <h3>Index</h3>
                              <div class="bs-docs-sidebar affix" id="affix">
                                <div></div>
                              </div>
                            </div>

                            
                            <div id="search-results">
                              <div class="search-list">Search Results for <span></span></div>
                              <div class="sr-items">
                                <p><span class="glyphicon glyphicon-refresh index-loading"></span></p>
                              </div>
                              <ul id="pagination" data-first="" data-prev="&#xf053;" data-next="&#xf054;" data-last=""></ul>
                            </div>

                        <article class="content wrap hide-when-search" id="_content" data-uid="">

                                <span class="small pull-right article mobile-hide" style="margin: 0;">
                                    <ul class="subnav contribution">
                                            <li>
                                                <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/docs/articles/async.md/#L1">Improve this Doc</a>
                                            </li>
                                    </ul>
                                </span>

<h1 id="async-module">Async Module</h1>

<p>This article will talk about how to use altv's thread safe.
All techniques described in this article will only work when you extend AsyncResource.</p>
<h2 id="setup-async-module">Setup async module</h2>
<p>First download the nuget package to access the async api's. <a href="https://www.nuget.org/packages/AltV.Net.Async">https://www.nuget.org/packages/AltV.Net.Async</a>
Next you need to inherit from <code>AsyncResource</code> instead of <code>Resource</code>.
Now you can use the async module.</p>
<h2 id="async-event-handlers">Async event handlers</h2>
<p>You can register a async event handler when using AltAsync instead of Alt for registering event handlers like</p>
<pre><code class="lang-cs">AltAsync.OnPlayerConnect += async (player, reason) =&gt; {
  Console.WriteLine($&quot;{player.Name} connected.&quot;);
  await DoAsyncStuff(player);
};
</code></pre>
<h2 id="use-apis-thread-safe">Use apis thread safe</h2>
<p>All api's related to entities like Player, Vehicle, Blip, ColShape, Checkpoint, VoiceChannel are not thread safe and will make your server crash when used wrong in async code.</p>
<h3 id="how-to-use-most-apis-thread-safe-without-performance-loose">How to use most apis thread safe without performance loose?</h3>
<p>You can get the position of a player in async code by preventing the player entity to get deleted while accessing the position.
This doesn't work with all apis</p>
<p>Small example:</p>
<pre><code class="lang-cs">Position position;
lock (player) {
  if (player.Exists) {
    position = player.Position
  }
}
Console.WriteLine(&quot;X:&quot; + position.X);
</code></pre>
<p>Lets breakdown the small code snippet.</p>
<p><code>Position position;</code>
We create a value to save the position into;
<code>lock (player)</code>
We lock the player to prevent access to it from multiple c# threads at the same time.
This also prevents the c# module to delete the player on disconnect.
Otherwise the server would end up crashing by accessing the player position of a deleted entity.
Note: locking the player when its already locked will end up in a deadlock. Never do this E.g. <code>lock (player) { lock (player) {  } }</code>
Locks also work accross method calls so be careful.
<code>if (player.Exists) {</code>
This if check is optional, because not checking it won't crash the server, but will throw a exception when the player doesn't exist anymore.
<code>position = player.Position</code>
Here we assign the position to the value we declared above. This is essential because no heavy calculations should happen inside a lock statement and the assign makes it possible to use the player position outside the lock statement for e.g. distance calculatione.</p>
<h3 id="how-to-use-all-apis-thread-safe">How to use all apis thread safe</h3>
<p>A few apis aren't possible to use thread safe from a different thread.
To use those apis we have to execute them on main thread. To make this easy for serverdev AltAsync has a method to do just this.</p>
<p>Here is a example.</p>
<pre><code class="lang-cs">var vehicle = await AltAsync.Do(() =&gt; Alt.CreateVehicle(VehicleModel.T20, player.Position, player.Rotation));
</code></pre>
<p>This example only works when called inside a method that is declared async.
AltAsync.Do will execute any code inside of it on the main thread. And will return the result when its awaited. You can also use AltAsync.Do when you don't care about the result and about the execution order.</p>
<p>When you need to call multiple apis at once don't do multiple AltAsync.Do when possible. Otherwise it may create a overhead on the main thread.</p>
<pre><code class="lang-cs">var vehicle = await AltAsync.Do(() =&gt; {
  var vehicle = Alt.CreateVehicle(VehicleModel.T20, player.Position, player.Rotation);
  var vehicle2 = Alt.CreateVehicle(VehicleModel.Chimera, player.Position, player.Rotation);
});
</code></pre>
<h2 id="threadsafe-methods-from-altvnetalt">Threadsafe methods from <code>AltV.Net.Alt</code></h2>
<h3 id="entity-pools">Entity pools</h3>
<p>The <code>AltV.Net.Async.AltAsync</code> class does not provide methods to interact with entity pools/lists. If you are using an <code>AsyncResource</code>, the methods for entity pooling on <code>AltV.Net.Alt</code> are overwritten and are threadsafe to use. This includes the following methods:</p>
<pre><code class="lang-csharp">public override IBaseEntityPool GetBaseEntityPool(IEntityPool&lt;IPlayer&gt; playerPool, IEntityPool&lt;IVehicle&gt; vehiclePool);
public override IBaseObjectPool&lt;IBlip&gt; GetBlipPool(IBaseObjectFactory&lt;IBlip&gt; blipFactory);
public override IBaseObjectPool&lt;ICheckpoint&gt; GetCheckpointPool(IBaseObjectFactory&lt;ICheckpoint&gt; checkpointFactory);
public override IBaseObjectPool&lt;IColShape&gt; GetColShapePool(IBaseObjectFactory&lt;IColShape&gt; colShapeFactory);
public override IEntityPool&lt;IPlayer&gt; GetPlayerPool(IEntityFactory&lt;IPlayer&gt; playerFactory);
public override IEntityPool&lt;IVehicle&gt; GetVehiclePool(IEntityFactory&lt;IVehicle&gt; vehicleFactory);
public override IBaseObjectPool&lt;IVoiceChannel&gt; GetVoiceChannelPool(IBaseObjectFactory&lt;IVoiceChannel&gt; voiceChannelFactory);
</code></pre>
<p>as they are overwritten in the <code>AsyncResource</code> class.</p>
</article>
                    </div>

                </div>

            </main>

        </div>

        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.2/jquery.twbsPagination.min.js" integrity="sha512-frFP3ZxLshB4CErXkPVEXnd5ingvYYtYhE5qllGdZmcOlRKNEPbufyupfdSTNmoF5ICaQNO6SenXzOZvoGkiIA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js" integrity="sha512-ubuT8Z88WxezgSqf3RLuNi5lmjstiJcyezx34yIU2gAHonIi27Na7atqzUZCOoY4CExaoFumzOsFQ2Ch+I/HCw==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js" integrity="sha512-8DnqlIcZT5O7kn55WxWs0PnFyhwCqVEnsDpyHqcadSNtP0eqae406JmIoo2cXT5A42jnlcCw013sdkmK3mEJcQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js" integrity="sha512-axd5V66bnXpNVQzm1c7u1M614TVRXXtouyWCE+eMYl8ALK8ePJEs96Xtx7VVrPBc0UraCn63U1+ARFI3ofW+aA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/1.8.8/url.min.js" integrity="sha512-r7Z8tYN1iMr6CTQ7pNJa2q+3owm4Tc6dLkVzGV68AFGiI0muMh5eLVQlas5kb9qwPY168HsTBctUwn3k0FVqyw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.0/anchor.min.js" integrity="sha512-G2OGlm41XXw+fcgDcRPjVYEn7qCY6qiKWNqDGT37SnKh0qtRXTuKZ5/UQR0kDN0PZRNWcGExd3lAeqEH0I36bQ==" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../styles/docfx.js"></script>
<script type="text/javascript" src="../../styles/discord.js"></script>
<script type="text/javascript" src="../../styles/main.js"></script>

    </body>

</html>

<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Entity Sync </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Entity Sync ">
    <meta name="generator" content="docfx 2.56.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css" integrity="sha512-xYwrX34LRktCfb+3WW0FtJf6qEc2tcJet152No8epFPBoM4qNaaVk5xdfCYI0Ns0H2jD0Isc3VoShSMv6zzpPA==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/solid.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../../styles/colors.css">
    <link rel="stylesheet" href="../../styles/discord.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>

  <body>

        <div class="body-content">

            <nav id="sidebar" role="navigation">

                <div class="sidebar">
                    
                    
                    
                    
                    <div>
                      
                      <a class="brand" href="../../index.html">
                        <img src="../../logo.svg" alt="alt:V" class="logomark">
                        <span class="brand-title">alt:V</span>
                      </a>
                      <div id="navbar">
                    
                      </div>
                    
                    </div>
                    

                    <div class="sidebar-item-separator"></div>

                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>

                </div>


            </nav>

            <main class="main-panel">

                <div class="blackout desktop-hide"></div>

                    
                    <div class="subnav navbar navbar-default">
                      <button class="btn-link search-back desktop-hide"></button>
                      <button class="btn-link navbar-toggler" aria-label="Toggle navigation"></button>
                      <div class="container" id="breadcrumb">
                        <ul class="breadcrumb">
                          <li></li>
                        </ul>
                      </div>
                      <div class="flex-space"></div>
                      <div class="toolbar">
                          <div style="position: relative;">
                            <form class="search-bar mobile-hide" role="search" id="search" style="position: relative;">
                              <button class="btn-link clear" id="search-query-clear"></button>
                              <!-- <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off"> -->
                              <div role="textbox" class="form-control" id="search-query" placeholder="Search" contenteditable="true"></div>
                            </form>
                            <div class="popout" id="search-menu">
                              <span class="title">
                                Search options:
                              </span>
                            </div>
                            <button class="btn-link search-tip desktop-hide"></button>
                          </div>
                      </div>
                      <button class="btn-link btn-floating search desktop-hide"></button>
                    </div>

                <div class="content-region" role="main">

                    <div class="content-column Conceptual">

                            
                            <div class="sideaffix hide-when-search">
                              <h3>Index</h3>
                              <div class="bs-docs-sidebar affix" id="affix">
                                <div></div>
                              </div>
                            </div>

                            
                            <div id="search-results">
                              <div class="search-list">Search Results for <span></span></div>
                              <div class="sr-items">
                                <p><span class="glyphicon glyphicon-refresh index-loading"></span></p>
                              </div>
                              <ul id="pagination" data-first="" data-prev="&#xf053;" data-next="&#xf054;" data-last=""></ul>
                            </div>

                        <article class="content wrap hide-when-search" id="_content" data-uid="">

                                <span class="small pull-right article mobile-hide" style="margin: 0;">
                                    <ul class="subnav contribution">
                                            <li>
                                                <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/docs/articles/entity-sync.md/#L1">Improve this Doc</a>
                                            </li>
                                    </ul>
                                </span>

<h1 id="entity-sync">Entity Sync</h1>

<p>This article will describes how to use the entity sync package to sync custom entities from serverside to clients efficiently.</p>
<h2 id="setup">Setup</h2>
<p>Install the following nuget packages and make sure both packages are on the latest version:
<a href="https://www.nuget.org/packages/AltV.Net.EntitySync">https://www.nuget.org/packages/AltV.Net.EntitySync</a> // The core package with the sync logic
<a href="https://www.nuget.org/packages/AltV.Net.EntitySync.ServerEvent">https://www.nuget.org/packages/AltV.Net.EntitySync.ServerEvent</a> // A optional package that will send the entity sync events to the client via server events</p>
<h2 id="configure-the-entity-sync">Configure the Entity Sync</h2>
<pre><code class="lang-csharp">AltEntitySync.Init(1, (threadId) =&gt; 100, (threadId) =&gt; false,
   (threadCount, repository) =&gt; new ServerEventNetworkLayer(threadCount, repository),
   (entity, threadCount) =&gt; (entity.Id % threadCount), 
   (entityId, entityType, threadCount) =&gt; (entityId % threadCount),
   (threadId) =&gt; new LimitedGrid3(50_000, 50_000, 100, 10_000, 10_000, 300),
   new IdProvider());
</code></pre>
<p>Now breakdown the parameters of the Init function:</p>
<p>The first parameter is the thread count, this describes the number of thats that will run in parallel to calculate the streamed entities.</p>
<p>The second parameter is the sync rate, it describes the interval in which each sync thread calculates the streamed entities and can be configured per thread id.</p>
<p>The third parameter is a bool with that you can enable net owner calculations and events.</p>
<p>The fourth parameter is the Action that returns a new NetworkLayer for a repository. The ServerEventNetworkLayer is part of the second nuget package.</p>
<p>The fifth parameter defines the thread the entity shoud use.</p>
<p>The sixth parameter defines the thread a entityId + entityType should use.</p>
<p>The seventh parameter is the Action that returns a new space partitioning algorithm for each specific sync thread id. The LimitedGrid3 is one of the algorithms that comes included in the core.
LimitedGrid3 has following parameters: (int maxX, int maxY, int areaSize, int xOffset, int yOffset, int limit).
The (int maxX, int maxY) parameters are defining the size of the map the grid is inserting, removing and finding entities in. The default values are defining the default gta 5 map.
The two offsets (int xOffset, int yOffset) preventing the corrdinates to become negative, because the gta maps goes from -10k to 50k.
The (int limit) makes sure a client can only have streamed in the amount of entities he can actually render. E.g. the gta 5 client in altv can only create around 300 Objects without stability issues.</p>
<p>The eight and last parameter is the id provider that increments the entity ids incremental and free's unused ids. The IdProvider is included inside the core package as well.</p>
<h2 id="add-entities">Add Entities</h2>
<p>To add entities that can be streamed there are two ways.</p>
<p>The easiert way is to use the CreateEntity method from AltEntitySync.</p>
<pre><code class="lang-csharp">AltEntitySync.CreateEntity(ulong type, Vector3 position, int dimension, uint range,
            IDictionary&lt;string, object&gt; data);
</code></pre>
<p>The entity type are your own ids to differentiate between e.g. a object, a ped, a 3d Text, ect.
The position is the entity position.
The dimension is working same as the dimension of a player, vehicle ect.
The range defines the streaming range this entity is streamed in.
The data is the data the entity contains when its streamed in on clientside.</p>
<p>The second way is to use the entity constructor.</p>
<pre><code class="lang-csharp">var entity = new Entity(ulong type, Vector3 position, int dimension, uint range,
            IDictionary&lt;string, object&gt; data);
AltEntitySync.AddEntity(entity);
</code></pre>
<h2 id="remove-entities">Remove entities</h2>
<p>To remove a entity you just need the entity or the entity id.</p>
<pre><code class="lang-csharp">AltEntitySync.RemoveEntity(IEntity entity);
// or
AltEntitySync.RemoveEntity(ulong id);
</code></pre>
<h2 id="update-entity-position">Update entity position</h2>
<p>The update the position of a entity just use the position setter.
The position is a Vector3.</p>
<pre><code class="lang-csharp">entity.Position = new Vector3(x, y, z);
</code></pre>
<h2 id="update-entity-range">Update entity range</h2>
<p>The update the range of a entity just use the range setter.
The range is a uint and should never be 0.</p>
<pre><code class="lang-csharp">entity.Range = range;
</code></pre>
<h2 id="update-entity-dimension">Update entity dimension</h2>
<p>The update the dimension of a entity just use the dimension setter.
The dimension is a int.</p>
<pre><code class="lang-csharp">entity.Dimension = dimension;
</code></pre>
<h2 id="update-entity-data">Update entity data</h2>
<p>The update the range of a entity just use the data methods.
Each type that works with <a href="custom-events.html">Custom Events</a> also works with ServerEventNetworkLayer.</p>
<pre><code class="lang-csharp">entity.SetData(&quot;my-data&quot;, 123);
</code></pre>
<p>You can reset the data with. Resetted data is received as null.</p>
<pre><code class="lang-csharp">entity.ResetData(&quot;my-data&quot;);
</code></pre>
<h2 id="get-entity-data">Get entity data</h2>
<pre><code class="lang-csharp">if (entity.TryGetData(&quot;my-data&quot;, out int data)) {

}
</code></pre>
<h2 id="get-entity-net-owner">Get entity net owner</h2>
<p>This is always null when third parameter is false, otherwise its the closest player to the entity.</p>
<pre><code class="lang-csharp">entity.NetOwner
</code></pre>
<h2 id="servereventnetworklayer">ServerEventNetworkLayer</h2>
<p>This describes the events the client receives from the ServerEventNetworkLayer that you need to implement in your client code.</p>
<h3 id="entity-create">Entity create</h3>
<p>This is called every time you come in the range of the entity.</p>
<p>The server assumes you cache the entity depending on the entity.id so make sure to do it.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:create&quot;, (entityId, entityType, position, newEntityData) =&gt; {
    alt.log(entityId);
    alt.log(entityType);
    alt.log(position);
    alt.log(newEntityData);
    if (newEntityData) {
       if (!entityData[entityType]) {
          entityData[entityType] = {};
       }
       if (!entityData[entityType][entityId]) {
            entityData[entityType][entityId] = {};
       }
       for (const key in newEntityData) {
           entityData[entityType][entityId][key] = newEntityData[key];
       }
    }
    let currentEntityData;
    if (entityData[entityType] &amp;&amp; entityData[entityType][entityId]) {
      currentEntityData = entityData[entityType][entityId];
    } else {
      currentEntityData = null;
    }
    alt.log(currentEntityData);
})
</code></pre>
<h3 id="entity-remove">Entity remove</h3>
<p>This is called every time you go out of the range of the entity.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:remove&quot;, (entityId, entityType) =&gt; {
    let currentEntityData;
    if (entityData[entityType]) {
         currentEntityData = entityData[entityType][entityId];
    } else {
         currentEntityData = null;
    }
    alt.log(entityId);
    alt.log(entityType);
    alt.log(entityData);
})
</code></pre>
<h3 id="entity-position-update">Entity position update</h3>
<p>This is called very time you update the entity position while you are in the range of the entity.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:updatePosition&quot;, (entityId, entityType, position) =&gt; {
    let currEntityData;
    if (entityData[entityType]) {
         currEntityData = entityData[entityType][entityId];
    } else {
         currEntityData = null;
    }
    alt.log(entityId);
    alt.log(entityType);
    alt.log(currEntityData);
})
</code></pre>
<h3 id="entity-data-update">Entity data update</h3>
<p>This is called every time you update the entity data while you are in the range of the entity.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:updateData&quot;, (entityId, entityType, newEntityData) =&gt; {
    if (!entityData[entityType]) {
       entityData[entityType] = {};
    }
    if (!entityData[entityType][entityId]) {
         entityData[entityType][entityId] = {};
    }
    if (newEntityData) {
       for (const key in newEntityData) {
           entityData[entityType][entityId][key] = newEntityData[key];
       }
    }
    let currentEntityData = entityData[entityType][entityId];
})
</code></pre>
<h3 id="entity-clear-cache">Entity clear cache</h3>
<p>This is called every time you remove a entity on serverside completely and clients still have data in cache of this entity.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:clearCache&quot;, (entityId, entityType) =&gt; {
    if (!entityData[entityType]) {
      return;
    }
    delete entityData[entityType][entityId];
})
</code></pre>
<h3 id="entity-net-owner">Entity net owner</h3>
<p>This is called when you set the third parameter to true and the current client becomes the net owner of the entity by beeing the closest player to the entity.</p>
<pre><code class="lang-js">alt.onServer(&quot;entitySync:netOwner&quot;, (entityId, entityType, isNetOwner) =&gt; {
    //...
})
</code></pre>
<p>Now you can call your own logic inside the events to spawn objects, npcs, 3d text, markers, ... ect.</p>
</article>
                    </div>

                </div>

            </main>

        </div>

        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.2/jquery.twbsPagination.min.js" integrity="sha512-frFP3ZxLshB4CErXkPVEXnd5ingvYYtYhE5qllGdZmcOlRKNEPbufyupfdSTNmoF5ICaQNO6SenXzOZvoGkiIA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js" integrity="sha512-ubuT8Z88WxezgSqf3RLuNi5lmjstiJcyezx34yIU2gAHonIi27Na7atqzUZCOoY4CExaoFumzOsFQ2Ch+I/HCw==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js" integrity="sha512-8DnqlIcZT5O7kn55WxWs0PnFyhwCqVEnsDpyHqcadSNtP0eqae406JmIoo2cXT5A42jnlcCw013sdkmK3mEJcQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js" integrity="sha512-axd5V66bnXpNVQzm1c7u1M614TVRXXtouyWCE+eMYl8ALK8ePJEs96Xtx7VVrPBc0UraCn63U1+ARFI3ofW+aA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/1.8.8/url.min.js" integrity="sha512-r7Z8tYN1iMr6CTQ7pNJa2q+3owm4Tc6dLkVzGV68AFGiI0muMh5eLVQlas5kb9qwPY168HsTBctUwn3k0FVqyw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.0/anchor.min.js" integrity="sha512-G2OGlm41XXw+fcgDcRPjVYEn7qCY6qiKWNqDGT37SnKh0qtRXTuKZ5/UQR0kDN0PZRNWcGExd3lAeqEH0I36bQ==" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../styles/docfx.js"></script>
<script type="text/javascript" src="../../styles/discord.js"></script>
<script type="text/javascript" src="../../styles/main.js"></script>

    </body>

</html>
